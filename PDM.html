<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fnac Darty – Clienteling</title>
  <link rel="icon" href="https://static.publicocdn.com/files/site/assets/img/commercial/fnac-logo.png" />
  <style>
    :root{
      --brand:#000;          /* noir Fnac */
      --accent:#ffd200;      /* jaune Fnac */
      --bg:#f6f6f6;
      --ink:#111;
      --muted:#6b7280;
      --card:#fff;
      --radius:18px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--ink);
      display:flex; align-items:center; justify-content:center;
    }
    .app{
      width:min(1280px, 96vw); height:min(820px, 92vh);
      background:linear-gradient(160deg, #fff, #fff 60%, #fff2);
      border-radius:28px; box-shadow:var(--shadow);
      overflow:hidden; display:grid; grid-template-rows:84px 1fr;
      border:1px solid #e5e7eb;
    }
    .topbar{
      display:flex; align-items:center; gap:16px; padding:16px 20px; background:#fff; border-bottom:1px solid #eee;
    }
    .logo{height:44px}
    .searchwrap{margin-left:auto; display:flex; align-items:center; gap:10px}
    .search{
      width:520px; max-width:64vw; height:44px; border:1.5px solid #ddd; border-radius:999px; padding:0 16px 0 48px; outline:none; font-size:16px; background:#fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>') no-repeat 14px center;
      transition:border-color .2s, box-shadow .2s
    }
    .search:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(255,210,0,.25)}
    .btn{height:44px; padding:0 14px; border-radius:999px; border:1.5px solid var(--brand); background:var(--brand); color:#fff; font-weight:600; cursor:pointer}
    .btn:hover{opacity:.9}
    .btn-secondary{background:#fff; color:var(--brand)}

    /* Suggestions */
    .suggest{position:absolute; top:70px; right:20px; width:min(640px, 92vw); background:#fff; border:1px solid #eee; border-radius:16px; box-shadow:var(--shadow); overflow:hidden; display:none}
    .s-item{padding:12px 14px; display:flex; gap:12px; align-items:center; cursor:pointer}
    .s-item:hover{background:#fafafa}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:var(--accent); color:#111; font-weight:700}
    .muted{color:var(--muted)}

    .layout{display:grid; grid-template-columns:1fr 1fr; gap:18px; padding:18px; height:100%;}
    .card{background:var(--card); border:1px solid #eee; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); display:none}
    .card.show{display:block}
    .card h3{margin:0 0 12px; font-size:18px}
    .kv{display:grid; grid-template-columns:180px 1fr; gap:10px; align-items:center}
    .kv input, .kv select{height:38px; padding:0 10px; border:1px solid #e5e7eb; border-radius:10px; outline:none}
    .kv input[readonly]{background:#fafafa}
    .row{display:flex; gap:10px}
    .row .btn{height:36px}

    .table{width:100%; border-collapse:collapse}
    .table th,.table td{padding:10px 8px; border-bottom:1px solid #eee; text-align:left}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6}

    .empty{height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; color:var(--muted)}
    .empty svg{width:72px; height:72px}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none}
    .modal{position:fixed; inset:0; display:grid; place-items:center; pointer-events:none}
    .sheet{width:min(560px, 92vw); background:#fff; border-radius:20px; box-shadow:var(--shadow); padding:18px; transform:translateY(20px); opacity:0; transition:.2s}
    .modal.show{pointer-events:auto}
    .modal.show .modal-backdrop{display:block}
    .modal.show .sheet{transform:none; opacity:1}
    .sheet h3{margin:0 0 12px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid .full{grid-column:1 / -1}
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <img class="logo" src="https://static.publicocdn.com/files/site/assets/img/commercial/fnac-logo.png" alt="Fnac Darty" />
      <div class="searchwrap" style="position:relative">
        <input id="q" class="search" placeholder="Rechercher par email, prénom, nom…" autocomplete="off" />
        <button id="newBtn" class="btn" title="Créer un nouveau contact">Nouveau contact</button>

        <div id="suggest" class="suggest"></div>
      </div>
    </header>

    <main class="layout">
      <!-- FICHE CLIENT -->
      <section id="cardDetails" class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px">
          <h3>Fiche client</h3>
          <div class="row">
            <button id="editToggle" class="btn btn-secondary" title="Éditer">Éditer</button>
            <button id="saveBtn" class="btn" style="display:none">Enregistrer</button>
          </div>
        </div>
        <div class="kv">
          <label>Prénom</label>
          <input id="firstName" readonly />
          <label>Nom</label>
          <input id="lastName" readonly />
          <label>Email</label>
          <input id="email" readonly />
          <label>Date de naissance</label>
          <input id="dob" readonly />
          <label>Opt-in Email</label>
          <select id="optinEmail" disabled>
            <option value="true">Oui</option>
            <option value="false">Non</option>
          </select>
          <label>Opt-in SMS</label>
          <select id="optinSMS" disabled>
            <option value="true">Oui</option>
            <option value="false">Non</option>
          </select>
          <label>Opt-in Push</label>
          <select id="optinPush" disabled>
            <option value="true">Oui</option>
            <option value="false">Non</option>
          </select>
          <label>Ville</label>
          <input id="city" readonly />
          <label>Code postal</label>
          <input id="zip" readonly />
          <label>Statut fidélité</label>
          <input id="statutFid" readonly />
          <label>Statut RFM</label>
          <input id="statutRFM" readonly />
          <label>Magasin favori</label>
          <input id="magasinFav" readonly />
        </div>
      </section>

      <!-- DERNIERS ACHATS -->
      <section id="cardPurchases" class="card">
        <h3>3 derniers produits achetés</h3>
        <table class="table" id="purchasesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Produit</th>
              <th>Marque</th>
              <th>Catégorie</th>
              <th>Qté</th>
              <th>Total TTC</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="emptyPurchases" class="empty" style="display:none">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 6h15l-1.5 9h-12z"/><path d="M6 6l-2 0"/><circle cx="9" cy="20" r="1"/><circle cx="18" cy="20" r="1"/></svg>
          <div>Aucun achat récent</div>
        </div>
      </section>

      <!-- ÉTAT VIDE (affiché tant qu'aucune recherche n'est faite) -->
      <section id="emptyState" class="card show" style="grid-column:1 / -1; text-align:center; display:block">
        <div class="empty">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <div>Commencez par saisir un email, un prénom ou un nom dans la barre de recherche.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALE NOUVEAU CONTACT -->
  <div id="modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="sheet">
      <h3>Nouveau contact</h3>
      <div class="grid">
        <div><label>Prénom</label><input id="n_firstName" /></div>
        <div><label>Nom</label><input id="n_lastName" /></div>
        <div class="full"><label>Email</label><input id="n_email" /></div>
        <div><label>Mobile</label><input id="n_mobile" /></div>
        <div><label>Ville</label><input id="n_city" /></div>
        <div><label>Code postal</label><input id="n_zip" /></div>
        <div><label>Opt-in Email</label>
          <select id="n_optinEmail"><option value="true">Oui</option><option value="false">Non</option></select>
        </div>
        <div><label>Opt-in SMS</label>
          <select id="n_optinSMS"><option value="false">Non</option><option value="true">Oui</option></select>
        </div>
        <div class="full row" style="justify-content:flex-end; margin-top:8px">
          <button id="cancelNew" class="btn btn-secondary">Annuler</button>
          <button id="createNew" class="btn">Créer</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ======= CONFIG (Swagger: Exposition RCU / RCU_Fnac_2) =======
const BASE_URL = 'https://fnacdarty-demo.poc2.imagino.com/ucdapi/Exposition_RCU/V1';
const ENDPOINT  = BASE_URL + '/RCU_Fnac_2';
const API_KEY   = 'c92ad264-f863-4f56-8e9e-22da8f8450a1'; // fourni par François

// ======= STATE =======
let cache = [];         // mémoire locale des enregistrements (GET /RCU_Fnac_2)
let selected = null;    // enregistrement sélectionné

// ======= HELPERS =======
const $ = sel => document.querySelector(sel);
const show = (el, on=true) => el.classList.toggle('show', on);
const enableEdit = (on)=>{
  ['firstName','lastName','email','dob','city','zip','statutFid','statutRFM','magasinFav'].forEach(id=>{
    const input = document.getElementById(id);
    input.readOnly = !on;
  });
  ['optinEmail','optinSMS','optinPush'].forEach(id=>{
    const s = document.getElementById(id); s.disabled = !on;
  });
  $('#saveBtn').style.display = on ? 'inline-flex' : 'none';
  $('#editToggle').textContent = on ? 'Annuler' : 'Éditer';
}
const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');

// ======= API =======
async function apiGET(url){
  const res = await fetch(url, { headers:{ 'X-API-KEY': API_KEY }});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}
async function apiPOST(url, payload){
  const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'X-API-KEY': API_KEY }, body: JSON.stringify(payload)});
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

async function ensureCache(){
  if(cache.length) return cache;
  const data = await apiGET(ENDPOINT + '?limit=1000');
  cache = (data && data.data) ? data.data : [];
  return cache;
}

// ======= SEARCH (client side filter on cached list) =======
const q = $('#q');
const suggest = $('#suggest');
q.addEventListener('input', async (e)=>{
  const term = norm(e.target.value);
  if(!term){ suggest.style.display='none'; return; }
  await ensureCache();
  const list = cache.filter(r=>{
    return norm(r.email).includes(term) || norm(r.firstName).includes(term) || norm(r.lastName).includes(term);
  }).slice(0,20);
  renderSuggestions(list);
});

function renderSuggestions(list){
  suggest.innerHTML = '';
  if(!list.length){ suggest.style.display='none'; return; }
  list.forEach(r=>{
    const div = document.createElement('div');
    div.className = 's-item';
    div.innerHTML = `
      <span class="badge">RCU</span>
      <div style="flex:1">
        <div><strong>${r.firstName||''} ${r.lastName||''}</strong> · <span class="muted">${r.email||''}</span></div>
        <div class="muted">${r.city||''} ${r.zipCode?('· '+r.zipCode):''}</div>
      </div>`;
    div.addEventListener('click', ()=> selectRecord(r));
    suggest.appendChild(div);
  });
  suggest.style.display='block';
}

// ======= SELECT & RENDER =======
function selectRecord(r){
  selected = r; suggest.style.display='none';
  $('#emptyState').style.display='none';
  show($('#cardDetails'), true);
  show($('#cardPurchases'), true);

  // Fiche
  $('#firstName').value = r.firstName || '';
  $('#lastName').value  = r.lastName  || '';
  $('#email').value     = r.email     || '';
  $('#dob').value       = r.dateOfBirth || '';
  $('#city').value      = r.city || '';
  $('#zip').value       = r.zipCode || '';
  $('#statutFid').value = r.Statut_Fidelite || '';
  $('#statutRFM').value = r.Statut_RFM || '';
  $('#magasinFav').value= r.Magasin_favori || '';
  $('#optinEmail').value= String(r.optInEmail===true);
  $('#optinSMS').value  = String(r.optInSMS===true);
  $('#optinPush').value = String(r.optInPush===true);
  enableEdit(false);

  // Achats
  const tb = document.querySelector('#purchasesTable tbody');
  tb.innerHTML='';
  const arr = Array.isArray(r['3_derniers_produits_achetes']) ? r['3_derniers_produits_achetes'] : [];
  if(!arr.length){
    document.getElementById('emptyPurchases').style.display='flex';
  } else {
    document.getElementById('emptyPurchases').style.display='none';
    arr.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.Order_date ? new Date(p.Order_date).toLocaleDateString() : ''}</td>
        <td>${p.product_name || ''}</td>
        <td><span class="pill">${p.brand||''}</span></td>
        <td>${p.category||''}</td>
        <td>${p.quantity??''}</td>
        <td>${typeof p.line_total_ttc==='number' ? (p.line_total_ttc.toFixed(2)+' €') : ''}</td>`;
      tb.appendChild(tr);
    });
  }
}

// ======= EDIT / SAVE =======
$('#editToggle').addEventListener('click', ()=>{
  const editing = $('#saveBtn').style.display !== 'none';
  enableEdit(!editing);
});

$('#saveBtn').addEventListener('click', async ()=>{
  if(!selected) return;
  try{
    const payload = {
      // write schema (RCU_Fnac_2-write)
      email:       $('#email').value,
      firstName:   $('#firstName').value,
      lastName:    $('#lastName').value,
      dateOfBirth: $('#dob').value || null,
      city:        $('#city').value || null,
      zipCode:     $('#zip').value || null,
      Statut_Fidelite: $('#statutFid').value || null,
      RFM:         $('#statutRFM').value || null,
      Magasin_favori: $('#magasinFav').value || null,
      optInEmail:  $('#optinEmail').value === 'true',
      optInSMS:    $('#optinSMS').value === 'true',
      optInPush:   $('#optinPush').value === 'true'
    };
    await apiPOST(ENDPOINT, payload);
    // update local cache copy
    Object.assign(selected, payload);
    enableEdit(false);
    alert('Profil mis à jour.');
  }catch(e){
    console.error(e); alert('Échec de la mise à jour: '+e.message);
  }
});

// ======= NEW CONTACT =======
const modal = document.getElementById('modal');
const openModal = (on)=>{ modal.classList.toggle('show', !!on); }

document.getElementById('newBtn').addEventListener('click', ()=> openModal(true));
document.querySelector('.modal-backdrop').addEventListener('click', ()=> openModal(false));
document.getElementById('cancelNew').addEventListener('click', ()=> openModal(false));

$('#createNew').addEventListener('click', async ()=>{
  const payload = {
    email: $('#n_email').value,
    firstName: $('#n_firstName').value,
    lastName:  $('#n_lastName').value,
    mobile:    $('#n_mobile').value || null,
    city:      $('#n_city').value || null,
    zipCode:   $('#n_zip').value || null,
    optInEmail: $('#n_optinEmail').value === 'true',
    optInSMS:   $('#n_optinSMS').value === 'true'
  };
  if(!payload.email){ alert('Email requis.'); return; }
  try{
    await apiPOST(ENDPOINT, payload);
    cache.unshift(payload); // naïf: on ajoute en tête pour la session
    openModal(false);
    q.value = payload.email; // préremplir la recherche
    renderSuggestions([payload]);
    alert('Contact créé.');
  }catch(e){ console.error(e); alert('Échec création: '+e.message); }
});
</script>
</body>
</html>
